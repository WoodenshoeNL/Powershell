{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "WebApp": {
          "type": "object",
          "metadata": {
              "description": "Object for Webapp properties"
          }
      },
      "location": {
        "type": "string",
        "defaultValue": "[resourceGroup().location]",
        "metadata": {
          "description": "Location for all resources."
        }
      }
    },
    "variables": {
      "webAppPortalName": "[concat(parameters('WebApp').webAppName)]",
      "appServicePlanName": "[concat(parameters('WebApp').webAppName, '-AppServicePlan')]",
      "apiVersions": {
          "serverfarms": "2017-08-01",
          "certificates": "2016-03-01",
          "hostnameBindings": "2016-03-01",
          "sites": "2016-08-01",
          "slots": "2016-08-01",
          "sitesResources": "2015-08-01"
      }
    },
    "resources": [
      {
          "comments": "This app service plan is used for the web app and slots.",
          "name": "[variables('appServicePlanName')]",
          "type": "Microsoft.Web/serverfarms",
          "apiVersion": "[variables('apiVersions').serverfarms]",
          "location": "[parameters('location')]",
          "dependsOn": [],
          "sku": {
              "name": "[parameters('WebApp').sku.name]",
              "tier": "[parameters('WebApp').sku.tier]",
              "size": "[parameters('WebApp').sku.size]",
              "family": "[parameters('WebApp').sku.family]",
              "capacity": "[parameters('WebApp').sku.capacity]"
          },
          "kind": "[if(bool(parameters('WebApp').Linux),'linux','app')]",
          "properties": {}
      },
      {
          "comments": "This is the web app, also the default 'nameless' slot.",
          "name": "[variables('webAppPortalName')]",
          "type": "Microsoft.Web/sites",
          "apiVersion": "[variables('apiVersions').sites]",
          "location": "[parameters('location')]",
          "dependsOn": [
              "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
          ],
          "properties": {
              "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
          },
          "resources": [
              {
                  "name": "web",
                  "type": "config",
                  "apiVersion": "[variables('apiVersions').sitesResources]",
                  "dependsOn": [
                      "[concat('Microsoft.Web/sites/', variables('webAppPortalName'))]"
                  ],
                  "properties": "[parameters('WebApp').ConfigProperties]"
              }
          ]
      },
      {
          "comments": "This specifies the web app slots.",
          "name": "[concat(variables('webAppPortalName'), '/', parameters('WebApp').slots[copyIndex()])]",
          "type": "Microsoft.Web/sites/slots",
          "apiVersion": "[variables('apiVersions').slots]",
          "location": "[parameters('location')]",
          "tags": {
              "displayName": "WebAppSlots"
          },
          "dependsOn": [
              "[resourceId('Microsoft.Web/Sites', variables('webAppPortalName'))]"
          ],
          "copy": {
              "name": "webPortalSlot",
              "count": "[length(parameters('WebApp').slots)]"
          },
          "properties": {
              "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
          }
      }
    ],
    "outputs": {
      "debug": {
          "value": "[string(if(bool(parameters('WebApp').Linux),'linux','app'))]",
          "type" : "string"
      }
    }
  }